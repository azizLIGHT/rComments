(function(){function a(j){var k=document.createElement('textarea');return k.innerHTML=j,k.value}function b(j,k){if(j.parentElement)return j.parentElement.matches(k)?j.parentElement:b(j.parentElement,k)}function c(j){var k='';for(key in j)k+=key+'='+j[key]+'&';return k.slice(0,-1)}// screw you jQuery
function f(j,k){'object'==typeof j?(k=j,j=k.url):!k&&(k={});var l=k.type||'GET',m=c(k.data||{});'GET'===l&&(j+='?'+m,m=void 0);var o=new XMLHttpRequest,p=new Promise((q,r)=>{o.onreadystatechange=function(){4===o.readyState&&200==o.status?q(JSON.parse(o.responseText)):4===o.readyState&&r()},o.ontimeout=()=>{r()},o.open(l,j,!0),k.timeout&&(o.timeout=k.timeout),o.setRequestHeader('content-type','application/x-www-form-urlencoded; charset=UTF-8'),o.send(m)});return p.abort=function(){o.abort()},p}var g={prefix:'_rcomments_',nextReplyText:'&#8618 Next Reply',nextCommentText:'&#8595 Next Comment',isLoggedIn:!1,getHtml:function(j){if(!j||!j.id)return this.noReplyHtml();this.data=j;var k=this.data,l='<div>'+a(k.body_html)+'</div>',m=this.buildTagline(),o=this.arrows(),p='<div id="'+k.id+'"" class="'+this.prefix+'comment comment thing">',q='<div class="entry">'+m+('<div>'+l+'</div>')+this.nextReply(!!k.replies)+'<div class="children"></div></div>';return p+o+q+'</div>'},noReplyHtml:function(){return'<div class="'+this.prefix+'comment comment thing">Oops, no more replies.</div>'},buildTagline:function(){return'<div class="tagline">'+this.authorTag()+this.voteTag()+'</div>'},voteTag:function(){var j=this.data.ups-this.data.downs;return'<span><span class="score dislikes">'+(j+1)+' points</span>'+('<span class="score unvoted">'+j+' points</span>')+('<span class="score likes">'+(j+1)+' points</span></span>')},nextReply:function(j){var k=j?this.prefix+'next_reply':this.prefix+'no_reply',l=j?this.nextReplyText:'No Replies';return'<div class="'+k+'">'+l+'</div>'},authorTag:function(){var j=this.data.author;return'<a class="author" href="/user/'+j+'">'+j+'</a>'},arrows:function(){if(!this.isLoggedIn)return'';this.data.ups-this.data.downs;var j=document.createElement('div'),k=document.createElement('div'),l=document.createElement('div');return j.className=this.prefix+'arrows unvoted',k.className='arrow up',l.className='arrow down',j.appendChild(k),j.appendChild(l),this.applyVote(j,this.data.likes).outerHTML},applyVote:function(j,k){var l=j.querySelector('.arrow.up, .arrow.upmod'),m=j.querySelector('.arrow.down, .arrow.downmod');return j.classList.remove('unvoted'),j.classList.remove('likes'),j.classList.remove('dislikes'),l.classList.remove('upmod'),l.classList.add('up'),m.classList.remove('downmod'),m.classList.add('down'),(1===k||!0===k?(j.classList.add('likes'),l.classList.remove('up'),l.classList.add('upmod')):-1===k||!1===k?(j.classList.add('dislikes'),m.classList.remove('down'),m.classList.add('downmod')):(j.classList.add('unvoted'),j.querySelector('.score')&&j.querySelector('.score').classList.add('unovoted')),j)}},h={model:{listingCache:{},htmlCache:{},commentStatus:{},currentListing:{},getRequestData:function(j,k){var l=this.requestParams(j,k);return data={url:j,params:l},k||(data.cached=this.cache(j)),data},requestParams:function(j,k){var l=this.genKey(j,k),m=this.commentStatus[l];return m||(m={depth:k?2:1,limit:k?1:0,// Incremented below
sort:'top'},k&&(m.comment=k)),m.limit++,this.commentStatus[l]=m,m},registerComment:function(j,k,l){var m=this.genKey(j,l),o=this.commentStatus[m],p=this.extractListingJson(k),q=this.extractCommentData(k,o);if(q)return this.listingCache[q.json.id]=p,this.currentListing=p,q},extractListingJson:function(j){return j[0].data.children[0].data},extractCommentData:function(j,k){var p,l=2==k.depth,m=k.limit-1,o=j[1].data.children;if(l){if(m--,o=o[0].data.replies.data,!o)return null;// Sometimes reddit lies to us. See below.
o=o.children}// Reddit had replied to parent comment saying there were
// more replies. They lied.
return o[m]?(p=!!o[m+1],{json:o[m].data,isLastReply:!p}):null;// "More comments"
},genKey:function(j,k){return j=this.cleanUrl(j),k?j+k:j},getUrl:function(j){var k=this.listingCache[j];return k?k.permalink:this.currentListing.permalink},cache:function(j,k){return j=this.cleanUrl(j),k?void(this.htmlCache[j]=k):this.htmlCache[j]},setCurrentListing:function(j){this.currentListing=this.listingCache[j]},cleanUrl:function(j){return j.slice(j.indexOf('/r/'));// Ok now I'm getting sloppy.
}},view:{popup:null,_id:'_rcomment_div',prefix:'_rcomments_',nextReplyText:'&#8618 Next Reply',nextCommentText:'&#8595 Next Comment',show:function(j,k){var m,l=g.getHtml(k);if(this.isFirstComment(j)){var m=this.popup(j);m.querySelector('.'+this.prefix+'content').innerHTML=l,m.style.display='block'}else{var o=j.querySelector('._rcomments_content, .children'),p=o.getElementsByClassName(this.prefix+'loading')[0];p&&p.parentNode.removeChild(p),o.innerHTML=l+o.innerHTML}},getPopup:function(){if(!this._popup){var j=document.createElement('div'),k=document.createElement('div'),l=document.createElement('div');k.className=this.prefix+'next_comment',k.innerHTML=this.nextCommentText,l.className=this.prefix+'content',j.id=this._id,j.style.display='none',j.appendChild(k),j.appendChild(l),document.body.appendChild(j),j.addEventListener('mouseleave',this.hidePopup.bind(this)),this._popup=j}return this._popup},popup:function(j){var k=this.getPopup(),l=k.getElementsByClassName(this.prefix+'next_comment_none')[0];l&&(l.innerHTML=this.nextCommentText,l.classList=[this.prefix+'next_comment']);var m=j.getBoundingClientRect();if(this.isFirstComment(j)){var o=window.window.pageYOffset,p=window.pageXOffset,q=k.getElementsByClassName(this.prefix+'next_comment')[0];q&&(q.innerHTML=this.nextCommentText),k.style.top=m.top+m.height+o+'px',k.style.left=m.left+p+'px'}return k},hidePopup:function(){this._popup&&(this._popup.style.display='none')},isFirstComment:function(j){return'a'===j.tagName.toLowerCase()},loading:function(j){var k=this.isFirstComment(j),l=this.prefix+'loading '+this.prefix+'comment comment thing',m='<div class="'+l+'"><span>Fetching comment...</span></div>';if(k){var o=this.popup(j);o.querySelector('.'+this.prefix+'content').innerHTML=m,o.style.display='block'}else{var p=j.querySelector('._rcomments_content, .children');p&&(p.innerHTML=m+p.innerHTML)}},loadContentHtml:function(j,k){this.popup(j).innerHTML=k},contentHtml:function(){return this._popup.innerHTML},updateParentComment:function(j,k){if(k){var l;for(var m=0;m<j.children.length;m++)if(j.children[m].classList.contains('entry')){l=j.children[m].querySelector('.'+this.prefix+'next_reply');break}l||(l=this._popup.querySelector('.'+this.prefix+'next_comment')),l.classList.contains(this.prefix+'next_comment')?(l.classList.remove(this.prefix+'next_comment'),l.classList.add(this.prefix+'next_comment_none'),l.innerHTML='No more Comments'):(l.classList.remove(this.prefix+'next_reply'),l.classList.add(this.prefix+'no_reply'),l.innerHTML='No More replies')}},handleError:function(j){var k='<div>A timeout error occured.</div>';if(this.isFirstComment(j))this.popup(j).querySelector('.'+this.prefix+'content').innerHTML=k;else{var l=j.querySelector('._rcomments_content, .children');l.innerHTML=k+l.innerHTML;var m=l.querySelector('.'+this.prefix+'loading');m&&m.remove()}}},request:new XMLHttpRequest,go:!1,disableRequest:!1,init:function(){var j=this.view.getPopup();f('/api/me.json').then(m=>{m.data&&(this.modhash=m.data.modhash,g.isLoggedIn=!0)});var k=document.querySelector('.sitetable .title.loggedin');k&&'_blank'===k.target&&(g.openInNewWindow=!0),j.addEventListener('click',m=>{return'_rcomments_next_reply'===m.target.className?this.renderComment(m.target.parentElement.parentElement):'_rcomments_next_comment'===m.target.className?this.renderComment(m.target.parentElement):m.target.classList&&'arrow'===m.target.classList[0]&&(m.stopImmediatePropagation(),this.handleVote(m.target)),!1});var l=!1;document.body.addEventListener('mousemove',m=>{var o=m.path.filter(function(p){return p&&'A'==p.nodeName&&p.classList&&p.classList.contains('comments')});1!==o.length||l&&l.href===o[0].href?l&&0===o.length&&(this.handleAnchorMouseLeave(m,l),l=!1):(l=o[0],this.handleAnchorMouseEnter(l))})},findClosestThing:function(j){for(;j;){if(j.classList&&j.classList.contains('thing'))return j;if(j=j.parentNode,'body'===j.tagName.toLowerCase())break}return!1},renderComment:function(j,k){if(!this.disableRequest){var r,s,t,l=this,m=l.request,o=!k&&this.findClosestThing(j).id,p=(j.href||l.model.getUrl(o))+'.json',q='_rcomment_div'===j.id,u=l.model.getRequestData(p,o);if(l.view.loading(j),m.abort(),u.cached&&!q){t=u.cached.content,l.view.loadContentHtml(j,t);var v=l.view.getPopup().querySelector('._rcomments_comment').id;return void l.model.setCurrentListing(v)}l.disableRequest=!0,m=f({url:u.url,data:u.params,timeout:4000}),m.then(function(x){r=l.model.registerComment(u.url,x,o),isLastReply=!0,r&&(s=r.json,isLastReply=r.isLastReply,o=r.json.id),l.view.show(j,s),l.view.updateParentComment(j,isLastReply),l.updateCache(u.url,o),l.disableRequest=!1},function(){l.view.handleError(j),l.disableRequest=!1}),this.request=m}},updateCache:function(j,k){k&&this.model.cache(j,{content:this.view.contentHtml(),commentId:k})},handleAnchorMouseEnter:function(j){var k=this;1>=j.text.split(' ').length||(k.go=!0,setTimeout(function(){k.go&&k.renderComment(j,!0)},250))},handleAnchorMouseLeave:function(j,k){var l=k.getBoundingClientRect(),m=l.top+window.pageYOffset+l.height;this.go=!1,j.pageY>=m||(this.request.abort(),this.view.hidePopup())},handleVote:function(j){if(this.modhash){var p,q,k=b(j,'.'+this.view.prefix+'comment'),l=k&&'t1_'+k.id,m=this.model.currentListing.permalink+'.json',o=b(j,'.comment').id;q=j.classList.contains('up')?1:j.classList.contains('down')?-1:0,p={id:l,dir:q,uh:this.modhash},f('/api/vote/.json',{type:'POST',data:p}),g.applyVote(j.parentElement,q),this.updateCache(m,o)}}};h.init()})();
