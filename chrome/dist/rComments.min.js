(b=>{function c(n){let o=document.createElement('textarea');return o.innerHTML=n,o.value}function f(n,o){if(n.parentElement)return n.parentElement.matches(o)?n.parentElement:f(n.parentElement,o)}function g(n){let o='';for(key in n)o+=key+'='+n[key]+'&';return o.slice(0,-1)}function h(n,o={}){'object'==typeof n&&(o=n,n=o.url);let p=o.type||'GET',q=g(o.data||{});'GET'===p&&(n+='?'+q,q=void 0);let r=new XMLHttpRequest,s=new Promise((t,u)=>{r.onreadystatechange=function(){4===r.readyState&&200==r.status?t(JSON.parse(r.responseText)):4===r.readyState&&u()},r.ontimeout=()=>{u()},r.open(p,n,!0),o.timeout&&(r.timeout=o.timeout),r.setRequestHeader('content-type','application/x-www-form-urlencoded; charset=UTF-8'),r.send(q)});return s.abort=function(){r.abort()},s}function j(n){return'_rcomments_'+n}const k='&#8595 Next Comment';let l={isLoggedIn:!1,openLinksInNewTab:!1,getHtml:function(n){if(!n||!n.id)return this.noReplyHtml();this.data=n;let o=this.data,p=`<div>${c(o.body_html)}</div>`,q=`<div>${p}</div>`,r=this.buildTagline(),s=this.arrows();if(this.openLinksInNewTab){let v=/(<a\s)(.*<\/a>)/;q=q.replace(v,'$1target="_blank" $2')}let t=`<div id="${o.id}" class="${j('comment comment thing')}">`,u='<div class="entry">'+r+q+this.nextReply(!!o.replies)+'<div class="children"></div></div>';return t+s+u+'</div>'},noReplyHtml:function(){return`<div class="${j('comment comment thing')}">Oops, no more replies.</div>`},buildTagline:function(){return`<div class="tagline">${this.authorTag()+this.voteTag()}</div>`},voteTag:function(){let n=this.data.ups-this.data.downs,o=`<span class="score unvoted">${n} points</span>`,p=`<span class="score likes">${n+1} points</span>`,q=`<span class="score dislikes">${n-1} points</span>`;return`<span>${q+o+p}</span>`},nextReply:function(n){let o=j(n?'next_reply':'no_reply'),p=n?'&#8618 Next Reply':'No Replies';return`<div class="${o}" style="padding-top:5px">${p}</div>`},authorTag:function(){let n=this.data.author;return`<a class="author" href="/user/${n}">${n}</a>`},arrows:function(){if(!this.isLoggedIn)return'';this.data.ups-this.data.downs;let n=document.createElement('div'),o=document.createElement('div'),p=document.createElement('div');return n.className=j('arrows unvoted'),o.className='arrow up',p.className='arrow down',n.appendChild(o),n.appendChild(p),this.applyVote(n,this.data.likes).outerHTML},applyVote:function(n,o){let p=n.querySelector('.arrow.up, .arrow.upmod'),q=n.querySelector('.arrow.down, .arrow.downmod');return n.classList.remove('unvoted'),n.classList.remove('likes'),n.classList.remove('dislikes'),p.classList.remove('upmod'),p.classList.add('up'),q.classList.remove('downmod'),q.classList.add('down'),(1===o||!0===o?(n.classList.add('likes'),p.classList.remove('up'),p.classList.add('upmod')):-1===o||!1===o?(n.classList.add('dislikes'),q.classList.remove('down'),q.classList.add('downmod')):(n.classList.add('unvoted'),n.querySelector('.score')&&n.querySelector('.score').classList.add('unovoted')),n)}},m={model:{listingCache:{},htmlCache:{},commentStatus:{},currentListing:{},getRequestData:function(n,o){let p=this.requestParams(n,o);return data={url:n,params:p},o||(data.cached=this.cache(n)),data},requestParams:function(n,o){let p=this.genKey(n,o),q=this.commentStatus[p];return q||(q={depth:o?2:1,limit:o?1:0,sort:'top'},o&&(q.comment=o)),q.limit++,this.commentStatus[p]=q,q},registerComment:function(n,o,p){let q=this.genKey(n,p),r=this.commentStatus[q],s=this.extractListingJson(o),t=this.extractCommentData(o,r);if(t)return this.listingCache[t.json.id]=s,this.currentListing=s,t},extractListingJson:function(n){return n[0].data.children[0].data},extractCommentData:function(n,o){let s,p=2==o.depth,q=o.limit-1,r=n[1].data.children;if(p){if(q--,r=r[0].data.replies.data,!r)return null;r=r.children}return r[q]?(s=!!r[q+1],{json:r[q].data,isLastReply:!s}):null},genKey:function(n,o){return n=this.cleanUrl(n),o?n+o:n},getUrl:function(n){let o=this.listingCache[n];return o?o.permalink:this.currentListing.permalink},cache:function(n,o){return n=this.cleanUrl(n),o?void(this.htmlCache[n]=o):this.htmlCache[n]},setCurrentListing:function(n){this.currentListing=this.listingCache[n]},cleanUrl:function(n){return n.slice(n.indexOf('/r/'))}},view:{popup:null,show:function(n,o){let p=l.getHtml(o);if(this.isFirstComment(n)){let q=this.popup(n);q.querySelector('.'+j('content')).innerHTML=p,q.style.display='block'}else{let q=n.querySelector('._rcomments_content, .children'),r=q.getElementsByClassName(j('loading'))[0];r&&r.parentNode.removeChild(r),q.innerHTML=p+q.innerHTML}},getPopup:function(){if(!this._popup){let n=document.createElement('div'),o=document.createElement('div'),p=document.createElement('div');o.className=j('next_comment'),o.innerHTML=k,p.className=j('content'),n.id='_rcomment_div',n.style.display='none',n.appendChild(o),n.appendChild(p),document.body.appendChild(n),n.addEventListener('mouseleave',this.hidePopup.bind(this)),this._popup=n}return this._popup},popup:function(n){let o=this.getPopup(),p=o.getElementsByClassName(j('next_comment_none'))[0];p&&(p.innerHTML=k,p.classList=[j('next_comment')]);let q=n.getBoundingClientRect();if(this.isFirstComment(n)){let r=b.window.pageYOffset,s=b.pageXOffset,t=o.getElementsByClassName(j('next_comment'))[0];t&&(t.innerHTML=k),o.style.top=q.top+q.height+r+'px',o.style.left=q.left+s+'px'}return o},hidePopup:function(){this._popup&&(this._popup.style.display='none')},isFirstComment:function(n){return'a'===n.tagName.toLowerCase()},loading:function(n){let o=this.isFirstComment(n),p=j('loading')+' '+j('comment comment thing'),q='<div class="'+p+'"><span>Fetching comment...</span></div>';if(o){let r=this.popup(n);r.querySelector('.'+j('content')).innerHTML=q,r.style.display='block'}else{let r=n.querySelector('._rcomments_content, .children');r&&(r.innerHTML=q+r.innerHTML)}},loadContentHtml:function(n,o){this.popup(n).innerHTML=o},contentHtml:function(){return this._popup.innerHTML},updateParentComment:function(n,o){if(o){let r;for(let s=0;s<n.children.length;s++)if(n.children[s].classList.contains('entry')){r=n.children[s].querySelector('.'+j('next_reply'));break}r||(r=this._popup.querySelector('.'+j('next_comment'))),r.classList.contains(j('next_comment'))?(r.classList.remove(j('next_comment')),r.classList.add(j('next_comment_none')),r.innerHTML='No more Comments'):(r.classList.remove(j('next_reply')),r.classList.add(j('no_reply')),r.innerHTML='No More replies')}},handleError:function(n){let o='<div>A timeout error occured.</div>';if(this.isFirstComment(n))this.popup(n).querySelector('.'+j('content')).innerHTML=o;else{let p=n.querySelector('._rcomments_content, .children');p.innerHTML=o+p.innerHTML;let q=p.querySelector('.'+j('loading'));q&&q.remove()}}},request:new XMLHttpRequest,go:!1,disableRequest:!1,init:function(){let n=this.view.getPopup();h('/api/me.json').then(q=>{!q||!q.data||!q.data.modhash||(this.modhash=q.data.modhash,l.openLinksInNewTab=/('|")new_window('|")\s?:\s?true/.test(b.config.innerHTML),l.isLoggedIn=!0)});let o=document.querySelector('.sitetable .title.loggedin');o&&'_blank'===o.target&&(l.openInNewWindow=!0),n.addEventListener('click',q=>{return'_rcomments_next_reply'===q.target.className?this.renderComment(q.target.parentElement.parentElement):'_rcomments_next_comment'===q.target.className?this.renderComment(q.target.parentElement):q.target.classList&&'arrow'===q.target.classList[0]&&(q.stopImmediatePropagation(),this.handleVote(q.target)),!1});let p=!1;document.body.addEventListener('mousemove',q=>{let r='A'===q.target.nodeName&&q.target.classList.contains('comments')&&q.target;!p&&!r||p&&r&&r.href===p.href||(!p&&r?(p=q.target,this.handleAnchorMouseEnter(r)):p&&(this.handleAnchorMouseLeave(q,p),p=!1))})},findClosestThing:function(n){for(;n;){if(n.classList&&n.classList.contains('thing'))return n;if(n=n.parentNode,'body'===n.tagName.toLowerCase())break}return!1},renderComment:function(n,o){if(!this.disableRequest){let C,D,E,y=this.request,z=!o&&this.findClosestThing(n).id,A=(n.href||this.model.getUrl(z))+'.json',B='_rcomment_div'===n.id,F=this.model.getRequestData(A,z);if(this.view.loading(n),y.abort(),F.cached&&!B){E=F.cached.content,this.view.loadContentHtml(n,E);let G=this.view.getPopup().querySelector('._rcomments_comment').id;return void this.model.setCurrentListing(G)}this.disableRequest=!0,y=h({url:F.url,data:F.params,timeout:4000}),y.then(G=>{C=this.model.registerComment(F.url,G,z),isLastReply=!0,C&&(D=C.json,isLastReply=C.isLastReply,z=C.json.id),this.view.show(n,D),this.view.updateParentComment(n,isLastReply),this.updateCache(F.url,z),this.disableRequest=!1},()=>{this.view.handleError(n),this.disableRequest=!1}),this.request=y}},updateCache:function(n,o){o&&this.model.cache(n,{content:this.view.contentHtml(),commentId:o})},handleAnchorMouseEnter:function(n){1>=n.text.split(' ').length||(this.go=!0,setTimeout(()=>{this.go&&this.renderComment(n,!0)},250))},handleAnchorMouseLeave:function(n,o){let p=o.getBoundingClientRect(),q=p.top+b.pageYOffset+p.height;this.go=!1,n.pageY>=q||(this.request.abort(),this.view.hidePopup())},handleVote:function(n){if(this.modhash){let C,D,y=f(n,'.'+j('comment')),z=y&&'t1_'+y.id,A=this.model.currentListing.permalink+'.json',B=f(n,'.comment').id;D=n.classList.contains('up')?1:n.classList.contains('down')?-1:0,C={id:z,dir:D,uh:this.modhash},h('/api/vote/.json',{type:'POST',data:C}),l.applyVote(n.parentElement,D),this.updateCache(A,B)}}};m.init()})(window);
