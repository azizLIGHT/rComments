(a=>{function b(m){let o=document.createElement('textarea');return o.innerHTML=m,o.value}function c(m,o){if(m.parentElement)return m.parentElement.matches(o)?m.parentElement:c(m.parentElement,o)}function f(m){let o='';for(key in m)o+=key+'='+m[key]+'&';return o.slice(0,-1)}function g(m,o={}){'object'==typeof m&&(o=m,m=o.url);let p=o.type||'GET',q=f(o.data||{});'GET'===p&&(m+='?'+q,q=void 0);let r=new XMLHttpRequest,s=new Promise((t,u)=>{r.onreadystatechange=function(){4===r.readyState&&200==r.status?t(JSON.parse(r.responseText)):4===r.readyState&&u()},r.ontimeout=()=>{u()},r.open(p,m,!0),o.timeout&&(r.timeout=o.timeout),r.setRequestHeader('content-type','application/x-www-form-urlencoded; charset=UTF-8'),r.send(q)});return s.abort=function(){r.abort()},s}function h(m){return'_rcomments_'+m}const j='&#8595 Next Comment';let k={isLoggedIn:!1,getHtml:function(m){if(!m||!m.id)return this.noReplyHtml();this.data=m;let o=this.data,p=`<div>${b(o.body_html)}</div>`,q=`<div>${p}</div>`,r=this.buildTagline(),s=this.arrows(),t=`<div id="${o.id}" class="${h('comment comment thing')}">`,u='<div class="entry">'+r+q+this.nextReply(!!o.replies)+'<div class="children"></div></div>';return t+s+u+'</div>'},noReplyHtml:function(){return`<div class="${h('comment comment thing')}">Oops, no more replies.</div>`},buildTagline:function(){return`<div class="tagline">${this.authorTag()+this.voteTag()}</div>`},voteTag:function(){let m=this.data.ups-this.data.downs,o=`<span class="score unvoted">${m} points</span>`,p=`<span class="score likes">${m+1} points</span>`,q=`<span class="score dislikes">${m-1} points</span>`;return`<span>${q+o+p}</span>`},nextReply:function(m){let o=h(m?'next_reply':'no_reply'),p=m?'&#8618 Next Reply':'No Replies';return`<div class="${o}" style="padding-top:5px">${p}</div>`},authorTag:function(){let m=this.data.author;return`<a class="author" href="/user/${m}">${m}</a>`},arrows:function(){if(!this.isLoggedIn)return'';this.data.ups-this.data.downs;let m=document.createElement('div'),o=document.createElement('div'),p=document.createElement('div');return m.className=h('arrows unvoted'),o.className='arrow up',p.className='arrow down',m.appendChild(o),m.appendChild(p),this.applyVote(m,this.data.likes).outerHTML},applyVote:function(m,o){let p=m.querySelector('.arrow.up, .arrow.upmod'),q=m.querySelector('.arrow.down, .arrow.downmod');return m.classList.remove('unvoted'),m.classList.remove('likes'),m.classList.remove('dislikes'),p.classList.remove('upmod'),p.classList.add('up'),q.classList.remove('downmod'),q.classList.add('down'),(1===o||!0===o?(m.classList.add('likes'),p.classList.remove('up'),p.classList.add('upmod')):-1===o||!1===o?(m.classList.add('dislikes'),q.classList.remove('down'),q.classList.add('downmod')):(m.classList.add('unvoted'),m.querySelector('.score')&&m.querySelector('.score').classList.add('unovoted')),m)}},l={model:{listingCache:{},htmlCache:{},commentStatus:{},currentListing:{},getRequestData:function(m,o){let p=this.requestParams(m,o);return data={url:m,params:p},o||(data.cached=this.cache(m)),data},requestParams:function(m,o){let p=this.genKey(m,o),q=this.commentStatus[p];return q||(q={depth:o?2:1,limit:o?1:0,sort:'top'},o&&(q.comment=o)),q.limit++,this.commentStatus[p]=q,q},registerComment:function(m,o,p){let q=this.genKey(m,p),r=this.commentStatus[q],s=this.extractListingJson(o),t=this.extractCommentData(o,r);if(t)return this.listingCache[t.json.id]=s,this.currentListing=s,t},extractListingJson:function(m){return m[0].data.children[0].data},extractCommentData:function(m,o){let s,p=2==o.depth,q=o.limit-1,r=m[1].data.children;if(p){if(q--,r=r[0].data.replies.data,!r)return null;r=r.children}return r[q]?(s=!!r[q+1],{json:r[q].data,isLastReply:!s}):null},genKey:function(m,o){return m=this.cleanUrl(m),o?m+o:m},getUrl:function(m){let o=this.listingCache[m];return o?o.permalink:this.currentListing.permalink},cache:function(m,o){return m=this.cleanUrl(m),o?void(this.htmlCache[m]=o):this.htmlCache[m]},setCurrentListing:function(m){this.currentListing=this.listingCache[m]},cleanUrl:function(m){return m.slice(m.indexOf('/r/'))}},view:{popup:null,show:function(m,o){let p=k.getHtml(o);if(this.isFirstComment(m)){let q=this.popup(m);q.querySelector('.'+h('content')).innerHTML=p,q.style.display='block'}else{let q=m.querySelector('._rcomments_content, .children'),r=q.getElementsByClassName(h('loading'))[0];r&&r.parentNode.removeChild(r),q.innerHTML=p+q.innerHTML}},getPopup:function(){if(!this._popup){let m=document.createElement('div'),o=document.createElement('div'),p=document.createElement('div');o.className=h('next_comment'),o.innerHTML=j,p.className=h('content'),m.id='_rcomment_div',m.style.display='none',m.appendChild(o),m.appendChild(p),document.body.appendChild(m),m.addEventListener('mouseleave',this.hidePopup.bind(this)),this._popup=m}return this._popup},popup:function(m){let o=this.getPopup(),p=o.getElementsByClassName(h('next_comment_none'))[0];p&&(p.innerHTML=j,p.classList=[h('next_comment')]);let q=m.getBoundingClientRect();if(this.isFirstComment(m)){let r=a.window.pageYOffset,s=a.pageXOffset,t=o.getElementsByClassName(h('next_comment'))[0];t&&(t.innerHTML=j),o.style.top=q.top+q.height+r+'px',o.style.left=q.left+s+'px'}return o},hidePopup:function(){this._popup&&(this._popup.style.display='none')},isFirstComment:function(m){return'a'===m.tagName.toLowerCase()},loading:function(m){let o=this.isFirstComment(m),p=h('loading')+' '+h('comment comment thing'),q='<div class="'+p+'"><span>Fetching comment...</span></div>';if(o){let r=this.popup(m);r.querySelector('.'+h('content')).innerHTML=q,r.style.display='block'}else{let r=m.querySelector('._rcomments_content, .children');r&&(r.innerHTML=q+r.innerHTML)}},loadContentHtml:function(m,o){this.popup(m).innerHTML=o},contentHtml:function(){return this._popup.innerHTML},updateParentComment:function(m,o){if(o){let r;for(let s=0;s<m.children.length;s++)if(m.children[s].classList.contains('entry')){r=m.children[s].querySelector('.'+h('next_reply'));break}r||(r=this._popup.querySelector('.'+h('next_comment'))),r.classList.contains(h('next_comment'))?(r.classList.remove(h('next_comment')),r.classList.add(h('next_comment_none')),r.innerHTML='No more Comments'):(r.classList.remove(h('next_reply')),r.classList.add(h('no_reply')),r.innerHTML='No More replies')}},handleError:function(m){let o='<div>A timeout error occured.</div>';if(this.isFirstComment(m))this.popup(m).querySelector('.'+h('content')).innerHTML=o;else{let p=m.querySelector('._rcomments_content, .children');p.innerHTML=o+p.innerHTML;let q=p.querySelector('.'+h('loading'));q&&q.remove()}}},request:new XMLHttpRequest,go:!1,disableRequest:!1,init:function(){let m=this.view.getPopup();g('/api/me.json').then(q=>{!q||!q.data||!q.data.modhash||(this.modhash=q.data.modhash,k.isLoggedIn=!0)});let o=document.querySelector('.sitetable .title.loggedin');o&&'_blank'===o.target&&(k.openInNewWindow=!0),m.addEventListener('click',q=>{return'_rcomments_next_reply'===q.target.className?this.renderComment(q.target.parentElement.parentElement):'_rcomments_next_comment'===q.target.className?this.renderComment(q.target.parentElement):q.target.classList&&'arrow'===q.target.classList[0]&&(q.stopImmediatePropagation(),this.handleVote(q.target)),!1});let p=!1;document.body.addEventListener('mousemove',q=>{let r=q.path.filter(function(s){return s&&'A'==s.nodeName&&s.classList&&s.classList.contains('comments')});1!==r.length||p&&p.href===r[0].href?p&&0===r.length&&(this.handleAnchorMouseLeave(q,p),p=!1):(p=r[0],this.handleAnchorMouseEnter(p))})},findClosestThing:function(m){for(;m;){if(m.classList&&m.classList.contains('thing'))return m;if(m=m.parentNode,'body'===m.tagName.toLowerCase())break}return!1},renderComment:function(m,o){if(!this.disableRequest){let C,D,E,y=this.request,z=!o&&this.findClosestThing(m).id,A=(m.href||this.model.getUrl(z))+'.json',B='_rcomment_div'===m.id,F=this.model.getRequestData(A,z);if(this.view.loading(m),y.abort(),F.cached&&!B){E=F.cached.content,this.view.loadContentHtml(m,E);let G=this.view.getPopup().querySelector('._rcomments_comment').id;return void this.model.setCurrentListing(G)}this.disableRequest=!0,y=g({url:F.url,data:F.params,timeout:4000}),y.then(G=>{C=this.model.registerComment(F.url,G,z),isLastReply=!0,C&&(D=C.json,isLastReply=C.isLastReply,z=C.json.id),this.view.show(m,D),this.view.updateParentComment(m,isLastReply),this.updateCache(F.url,z),this.disableRequest=!1},()=>{this.view.handleError(m),this.disableRequest=!1}),this.request=y}},updateCache:function(m,o){o&&this.model.cache(m,{content:this.view.contentHtml(),commentId:o})},handleAnchorMouseEnter:function(m){1>=m.text.split(' ').length||(this.go=!0,setTimeout(()=>{this.go&&this.renderComment(m,!0)},250))},handleAnchorMouseLeave:function(m,o){let p=o.getBoundingClientRect(),q=p.top+a.pageYOffset+p.height;this.go=!1,m.pageY>=q||(this.request.abort(),this.view.hidePopup())},handleVote:function(m){if(this.modhash){let C,D,y=c(m,'.'+h('comment')),z=y&&'t1_'+y.id,A=this.model.currentListing.permalink+'.json',B=c(m,'.comment').id;D=m.classList.contains('up')?1:m.classList.contains('down')?-1:0,C={id:z,dir:D,uh:this.modhash},g('/api/vote/.json',{type:'POST',data:C}),k.applyVote(m.parentElement,D),this.updateCache(A,B)}}};l.init()})(window);
